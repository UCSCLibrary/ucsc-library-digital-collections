language: ruby
cache:
  bundler: true
git:
  strategy: clone
  depth: 1
  quiet: true
rvm: 2.4.1
branches:
- docker-test
stages:
- unit_tests
- integration_tests
- deployment
- acceptance_tests
_docker_test_job:
  cache: &1
    apt: true
    directories:
    - "${HOME}/ucsc_docker/"
    - "/usr/local/bin/docker-compose"
  services: &2
  - docker
  git: &3
    clone: false
  before_install: &4
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
  - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu
    $(lsb_release -cs) stable"
  - sudo apt-get update
  - sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-ce
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-Linux-x86_64
    > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin
  - git -C ${HOME}/ucsc_docker pull || git clone -b $TEST_BRANCH https://github.com/UCSCLibrary/digital_collections_dev_docker.git
    ${HOME}/ucsc_docker/
  install: &5
  - cd ${HOME}/ucsc_docker/
  - touch .env.development
  - docker-compose build
  - docker-compose up -d
  - docker ps
  before_script: &6
  - docker exec hycruz /srv/wait-for-services.sh db:3306 -t 180
  - docker exec hycruz /srv/wait-for-services.sh repo:8080 -t 180
  - docker exec hycruz /srv/wait-for-services.sh index:8983 -t 180
  - docker exec hycruz /srv/wait-for-services.sh localhost:3000 -t 300
  script: docker exec hycruz bundle exec rspec spec/$TEST_DIR
jobs:
  include:
  - name: unit tests
    stage: unit_tests
    cache: *1
    services: *2
    git: *3
    before_install: *4
    install: *5
    before_script: *6
    script: docker exec hycruz bundle exec rspec spec/$TEST_DIR
    env:
    - TEST_DIR: unit
    - TEST_BRANCH: unit-test
    - DOCKER_COMPOSE_VERSION: 1.25.4
  - name: integration tests
    stage: integration_tests
    cache: *1
    services: *2
    git: *3
    before_install: *4
    install: *5
    before_script: *6
    script: docker exec hycruz bundle exec rspec spec/$TEST_DIR
    env:
    - TEST_DIR: integration
    - TEST_BRANCH: integration-test
    - DOCKER_COMPOSE_VERSION: 1.25.4
  exclude:
  - name: deployment
    stage: deployment
    script:
    - [[ $TRAVIS_BRANCH = master ]] && CAP_ENV="production" || CAP_ENV=$TRAVIS_BRANCH
    - bundle exec cap $CAP_ENV deploy BRANCH=$TRAVIS_BRANCH
    before_install:
    - openssl aes-256-cbc -K $encrypted_52af377e3440_key -iv $encrypted_52af377e3440_iv -in hycruz_deploy_rsa.enc -out hycruz_deploy_rsa -d
  - name: acceptance tests
    branch: master
    stage: acceptance_tests
    script: bundle exec rspec spec/acceptance/
    after_failure:
    - openssl aes-256-cbc -K $encrypted_52af377e3440_key -iv $encrypted_52af377e3440_iv -in hycruz_deploy_rsa.enc -out hycruz_deploy_rsa -d
    - bundle exec cap $TRAVIS_BRANCH deploy:rollback BRANCH=$TRAVIS_BRANCH
    addons:
    - firefox:latest
#    sauce_connect:
#      enabled: true
#      username:
#        secure: "BUKFdRlo2cC0zl9ZzjeEciIbO9d05ol1kutU3VlMV+XI5gBYX4+24L4BMHnFPpde18EA1d84hI7wqGgHgbkuMO44K9QL9qu5O20W2a4cVZ5psrk7IquoZmx2riAXoZdazFr4ok2C4QsFv2sHpHMHoX66lR7bdC7j/U2q7ZLFC80xN560gJhhfe6lTPriy7VIotIbDa8E8SDv1ZkGg/ZaNyqxD43MPw1SbYoAyPjgCZU+pSyxeFcOnGYMa/sV3JK3uOhdu1UnhNE6x1ujNAnSJfgkNfpaHj1+H0cQi/ovUPYPkxgbZ0Rc/4Lr//LBLsUgqTwaecG+h+Fqri9kbYYw4ygUlL7IPKIvk8GSwc31h0hwqO4np5w8A+kYHGkds44BDqZxjnvn2I7daynHgf/ygV+WlYReNEDWRGde66KuIagMnegrMo394HnYmJELYzxduqTXD4bgsCv6SzRlaXXlCB67TkQQnCd+QofP3YMGGCDwHdj6p6CTUB8uGZWDTfg1j1jZhabmYi1ZwdUekkbFDzjEUZox24INKHYvFVhwCgF+lZ6WBtBryyPIugE/Ocu4pYR1R4qbmstZiShb/telflCkxRxOQE8T4MurBpnJPCM8eeDZ0KTh2AUY6ejcvmjPbRWiKMsgWemq99AlXMkj9dV+n7wCR6hp8hZzWvSY6dE="
#      access_key:
#        secure: "t76ow0TNOvjnBI29Y+DbmtVNvkvDCgmympIcCs3S4wsB+QZGxQ4ruVTMlLzGXB3XpmY5Z+JYzPevpMoEEVIBg3unJhWrEe7U9IYdjo1oRdkUIGEeKJqqZ8eymUFSJAKa78du4sln5thii3CVSM/Q4xeYKCOJsR27amrUo9LaU07eZspBKgWa/eKvcS1zXgdGK5aW6g4O56Vjp8Ml8nkeiS7Nam8NKkGg/vn+QtjZ8F52N7t3yOtsx/hUOw4V9fFA4my2SmgX6UdkBajGuQA5Z3mfyRWmPOfr+NfajXNgp6FPg33EhmicNAhawf5eTmHsuCMBjrBzjt6zwlkzLhMV9QclPI1EuxMjWgr3xPqe5Ir5p3keOKB6rvaJ8jckZLIAMFdzeNbvaUPHDsnWO04IgQAhe8PqPuE4PdVAsmcZTJKqMa3aLRAxd4RRJrnIWHG+GKG0BXDfBfqQZCH8qF+2M8TQxEeP+o8p0bxVYVWeW4kPuJisk02q7d1N2hbPzun+S92u9BXvmbHMPYJ26RkQlRZM2W4GXajzILlh5KZRGzByG3+3Rf+DkDSErBRXA7hjv/6/n+NJ3S0sBA6F9JDfYLayciDkT05ego+erZfAZrYNcZrWLUlkYP8G5+kBiWLeEPdQXxBEOyn+PHrpDhntUZmo3UUUp3mLvq41DyTaSNk="
